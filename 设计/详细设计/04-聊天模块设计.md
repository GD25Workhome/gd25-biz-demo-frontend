# 聊天模块设计
环境说明：本文以 macOS 开发环境为准。

## 目标
- 支持发送消息与轮询拉取新消息，展示在聊天界面
- 具备乐观更新、错误回滚与可扩展的实时推送能力

## 消息模型
```ts
type ChatMessage = {
  id: string
  conversationId: string
  role: 'user' | 'assistant' | 'system'
  content: string
  createdAt: string
}
```

## 接口契约（示例）
- 发送：`POST /api/chat/send`，请求体 `{ conversationId, content, role }`
- 拉取：`GET /api/chat/messages?conversationId=<id>&since=<timestamp>` 返回 `{ messages: ChatMessage[] }`

## 数据流
1. 用户在 `ChatInput` 输入并发送 → 调用 `sendMessage`
2. UI 乐观插入用户消息；若失败则回滚并提示
3. `useQuery` 以 `refetchInterval` 轮询新消息（增量，基于 `since`）
4. 新消息追加到 `MessageList` 并滚动至底部

## 组件职责
- `pages/Chat/ChatPage.tsx`：页面容器，组合消息列表与输入框，管理会话 ID
- `components/MessageList.tsx`：按角色与时间渲染消息，处理滚动与长文本
- `components/ChatInput.tsx`：输入与发送按钮，处理禁用态与提交

## 轮询策略
- 间隔：默认 2s，可根据负载与实时性调整
- 暂停：当页面不活跃或会话切换时暂停轮询
- 去重：按消息 `id` 去重；基于最新 `createdAt` 作为 `since`

## 乐观更新与回滚
- 发送前立即在 UI 展示用户消息（带临时 ID）
- 后端返回失败时移除临时消息并弹出错误
- 成功返回时用后端消息替换临时消息，保证一致性

## 可扩展：SSE/WebSocket
- 抽象数据源层于 `services/api/chat.ts`：提供 `subscribe()` 接口
- 新增 SSE/WebSocket 实现，向上层暴露统一事件流；保留轮询作为降级方案

## 可靠性与并发
- 幂等：可为发送请求增加 `clientMessageId`，防止重复入库
- 取消：在路由跳转或会话切换时取消未完成请求，避免状态污染
- 超时：`axios` 配置请求超时，异常路径统一提示
